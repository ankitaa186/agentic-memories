# docker-compose.prod.yml
# Production overrides - Grafana Cloud Loki logging
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Or via Makefile:
#   make start ENV=prod
#
# Prerequisites:
#   1. Install Loki Docker plugin:
#      docker plugin install grafana/loki-docker-driver:latest --alias loki --grant-all-permissions
#   2. Set LOKI_URL in .env:
#      LOKI_URL=https://<user-id>:<api-key>@logs-prod-us-central1.grafana.net/loki/api/v1/push
#
# This file extends docker-compose.yml with Loki logging driver configuration
# for all services. Logs are shipped to Grafana Cloud for remote observability.

x-loki-logging: &loki-logging
  driver: loki
  options:
    loki-url: "${LOKI_URL}"
    loki-retries: "5"
    loki-batch-size: "400"
    loki-timeout: "2s"

services:
  api:
    logging:
      <<: *loki-logging
      options:
        loki-url: "${LOKI_URL}"
        loki-external-labels: "service=api,env=prod,project=agentic-memories"

  ui:
    logging:
      <<: *loki-logging
      options:
        loki-url: "${LOKI_URL}"
        loki-external-labels: "service=ui,env=prod,project=agentic-memories"

  redis:
    logging:
      <<: *loki-logging
      options:
        loki-url: "${LOKI_URL}"
        loki-external-labels: "service=redis,env=prod,project=agentic-memories"
