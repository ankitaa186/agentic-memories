<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>5</storyId>
    <title>Portfolio Condition Type</title>
    <status>drafted</status>
    <generatedAt>2025-12-24</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/6-5-portfolio-condition-type.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Annie Proactive Worker</asA>
    <iWant>portfolio-based condition triggers</iWant>
    <soThat>I can create proactive alerts when portfolio holdings change significantly (e.g., "any stock down 5%")</soThat>
    <tasks>
      <task id="1" name="Database Migration - Add 'portfolio' Trigger Type" ac="5.1">
        <subtask id="1.1">Create migrations/postgres/023_portfolio_trigger_type.up.sql</subtask>
        <subtask id="1.2">Drop existing CHECK constraint chk_trigger_type</subtask>
        <subtask id="1.3">Add new CHECK constraint including 'portfolio'</subtask>
        <subtask id="1.4">Create down migration 023_portfolio_trigger_type.down.sql</subtask>
      </task>
      <task id="2" name="Update Pydantic Model Validation" ac="5.1">
        <subtask id="2.1">Update ScheduledIntentCreate.trigger_type Literal to include 'portfolio'</subtask>
        <subtask id="2.2">Add 'portfolio' to CONDITION_TRIGGER_TYPES constant</subtask>
        <subtask id="2.3">Verify OpenAPI schema includes 'portfolio' in trigger_type enum</subtask>
      </task>
      <task id="3" name="Implement Portfolio Expression Validation" ac="5.2">
        <subtask id="3.1">Create _validate_portfolio_expression() function in intent_validation.py</subtask>
        <subtask id="3.2">Define regex patterns for portfolio expressions</subtask>
        <subtask id="3.3">Add validation call when condition_type='portfolio'</subtask>
        <subtask id="3.4">Return clear error messages for invalid expressions</subtask>
      </task>
      <task id="4" name="Set Default check_interval_minutes for Portfolio" ac="5.3">
        <subtask id="4.1">In create/update intent logic, detect trigger_type='portfolio'</subtask>
        <subtask id="4.2">If check_interval_minutes not explicitly set, default to 15</subtask>
        <subtask id="4.3">Validate condition_type='portfolio' is set for portfolio triggers</subtask>
        <subtask id="4.4">Validate expression field is present and valid</subtask>
      </task>
      <task id="5" name="Unit Tests" ac="5.1, 5.2, 5.3">
        <subtask id="5.1">Test 'portfolio' is valid trigger_type</subtask>
        <subtask id="5.2">Test portfolio expression validation - valid cases</subtask>
        <subtask id="5.3">Test portfolio expression validation - invalid cases</subtask>
        <subtask id="5.4">Test default check_interval_minutes=15 for portfolio</subtask>
        <subtask id="5.5">Test explicit check_interval_minutes override</subtask>
        <subtask id="5.6">Test missing condition_type for portfolio trigger returns error</subtask>
        <subtask id="5.7">Test missing expression for portfolio trigger returns error</subtask>
      </task>
      <task id="6" name="Integration Tests" ac="5.1, 5.2, 5.3">
        <subtask id="6.1">Create portfolio intent with valid expression, verify stored</subtask>
        <subtask id="6.2">Create portfolio intent without expression, verify 400 error</subtask>
        <subtask id="6.3">Create portfolio intent with invalid expression, verify 400 error</subtask>
        <subtask id="6.4">Create portfolio intent, verify check_interval_minutes=15 default</subtask>
        <subtask id="6.5">Verify portfolio triggers appear in pending query</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC5.1" title="'portfolio' added to trigger_type CHECK constraint">
      <requirement>Update CHECK constraint in scheduled_intents table to include 'portfolio'</requirement>
      <requirement>Add 'portfolio' to trigger_type validation whitelist in Pydantic model</requirement>
      <requirement>New CHECK constraint: ('cron', 'interval', 'once', 'price', 'silence', 'portfolio')</requirement>
    </criterion>
    <criterion id="AC5.2" title="Portfolio expressions validated">
      <requirement>Given condition_type='portfolio', validate expression format</requirement>
      <requirement>Supported: any_holding_change, any_holding_down, any_holding_up, total_value, total_change</requirement>
      <requirement>Return validation error for unsupported expression formats</requirement>
    </criterion>
    <criterion id="AC5.3" title="Default check_interval_minutes=15 for portfolio triggers">
      <requirement>When trigger_type='portfolio', default check_interval_minutes=15 (not 5)</requirement>
      <requirement>User can still explicitly set lower values if needed</requirement>
      <requirement>Require condition_type='portfolio' and valid expression for portfolio triggers</requirement>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/sprint-artifacts/tech-spec-epic-6.md" title="Epic 6 Tech Spec" section="Story 6.5: Portfolio Condition Type">
        AC5.1-AC5.3 define portfolio requirements: CHECK constraint update, expression validation with keywords (any_holding_change, total_value, etc.), and default check_interval_minutes=15.
      </doc>
      <doc path="docs/epic-6-intents-api-alignment.md" title="Epic 6: Intents API Alignment" section="Story 6.5: Portfolio Condition Type">
        Goal: Add 'portfolio' trigger type for portfolio-based conditions. Portfolio joins price/silence as condition-based triggers with cooldown and fire_mode support.
      </doc>
      <doc path="docs/sprint-artifacts/6-4-fire-mode-support.md" title="Story 6.4: Fire Mode Support" section="Dev Notes">
        Previous story provides patterns: migration numbering (now 023), CONDITION_TRIGGER_TYPES constant update, validation pattern from _validate_price_expression().
      </doc>
    </docs>
    <code>
      <file path="src/schemas.py" kind="models" symbol="ScheduledIntentCreate.trigger_type" lines="306" reason="Update trigger_type Literal to include 'portfolio' alongside existing types">
        Current: Literal["cron", "interval", "once", "price", "silence", "portfolio"]. Already includes 'portfolio' - verify and document.
      </file>
      <file path="src/services/intent_service.py" kind="service" symbol="CONDITION_TRIGGER_TYPES" lines="93" reason="Update constant to include 'portfolio' for cooldown/fire_mode applicability">
        Current: CONDITION_TRIGGER_TYPES = {"price", "silence", "portfolio"}. Already includes 'portfolio' - verify.
      </file>
      <file path="src/services/intent_validation.py" kind="service" symbol="PORTFOLIO_KEYWORDS" lines="54-57" reason="Portfolio expression keywords already defined - extend regex validation">
        Contains: any_holding_change, any_holding_up, any_holding_down, total_value, total_change. Need full regex validation per AC5.2.
      </file>
      <file path="src/services/intent_validation.py" kind="service" symbol="_validate_condition_expression" lines="387-479" reason="Existing portfolio expression validation - may need regex enhancement for percentage format">
        Current validation checks for keyword prefix only. Need strict regex per story: percentage patterns and absolute value patterns.
      </file>
      <file path="src/services/intent_validation.py" kind="service" symbol="REQUIRED_FIELDS" lines="40-47" reason="Already has 'portfolio' entry - verify expression field requirement">
        Current: "portfolio": {"condition": []}. May need to require expression field explicitly.
      </file>
      <file path="migrations/postgres/017_scheduled_intents.up.sql" kind="migration" lines="46-48" reason="Original CHECK constraint definition - pattern for migration 023">
        Shows constraint format: CHECK (trigger_type IN ('cron', 'interval', 'once', 'price', 'silence', ...))
      </file>
      <file path="migrations/postgres/022_fire_mode.up.sql" kind="migration" lines="1-17" reason="Recent migration pattern to follow for migration 023">
        Pattern: ALTER TABLE, DROP CONSTRAINT IF EXISTS, ADD CONSTRAINT with CHECK, COMMENT ON COLUMN.
      </file>
      <file path="tests/unit/test_fire_mode.py" kind="test" lines="1-229" reason="Pattern for unit test organization - follow for test_portfolio_trigger.py">
        Test class structure: TestXxxValidation, TestXxxWithOtherFields, TestXxxApplicability, etc.
      </file>
      <file path="tests/integration/test_intents_api.py" kind="test" symbol="TestConditionExpression" lines="1393-1819" reason="Add TestPortfolioTrigger class following this pattern">
        Integration test pattern for condition-based triggers with expression validation.
      </file>
    </code>
    <dependencies>
      <python>
        <package name="pydantic" version="^2.0">BaseModel, Field, Literal for model definition</package>
        <package name="pytest" version="^7.0">Testing framework for unit and integration tests</package>
        <package name="psycopg[binary]" version="^3.1">PostgreSQL driver for database operations</package>
        <package name="re" version="stdlib">Regular expressions for portfolio expression validation</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint source="Architecture">Use existing TriggerCondition model pattern in src/schemas.py</constraint>
    <constraint source="Architecture">Follow existing validation pattern in intent_validation.py</constraint>
    <constraint source="Architecture">Migration must update CHECK constraint without data loss</constraint>
    <constraint source="Dev Notes">Portfolio triggers use CONDITION_TRIGGER_TYPES for cooldown/fire_mode</constraint>
    <constraint source="Dev Notes">Use migration file 023 per project numbering convention</constraint>
    <constraint source="Dev Notes">Portfolio expression validation must support both percentage and absolute formats</constraint>
    <constraint source="Testing">Create dedicated test file tests/unit/test_portfolio_trigger.py</constraint>
  </constraints>

  <interfaces>
    <interface name="ScheduledIntentCreate.trigger_type" kind="pydantic-field" path="src/schemas.py">
      trigger_type: Literal["cron", "interval", "once", "price", "silence", "portfolio"]
    </interface>
    <interface name="CONDITION_TRIGGER_TYPES" kind="constant" path="src/services/intent_service.py">
      CONDITION_TRIGGER_TYPES = {"price", "silence", "portfolio"} - for cooldown/fire_mode applicability
    </interface>
    <interface name="Portfolio Expression Regex" kind="validation" path="src/services/intent_validation.py">
      percentage: ^(any_holding_change|any_holding_down|any_holding_up|total_change)\s*(>|>=|&lt;|&lt;=)\s*(\d+(\.\d+)?)%$
      absolute: ^total_value\s*(>|>=|&lt;|&lt;=)\s*(\d+(\.\d+)?)$
    </interface>
    <interface name="POST /v1/intents" kind="REST endpoint" path="src/routers/intents.py">
      Accepts trigger_type='portfolio' with trigger_condition.expression and condition_type='portfolio'
    </interface>
  </interfaces>

  <tests>
    <standards>
      pytest framework with fixtures for database setup. Unit tests mock database connections.
      Integration tests use real database with test isolation. Test class naming: Test{FeatureName}.
      Follow existing patterns in test_fire_mode.py and test_intents_api.py.
    </standards>
    <locations>
      <location>tests/unit/test_portfolio_trigger.py (new file)</location>
      <location>tests/integration/test_intents_api.py (extend with TestPortfolioTrigger class)</location>
    </locations>
    <ideas>
      <idea ac="AC5.1">Test 'portfolio' is valid trigger_type in ScheduledIntentCreate</idea>
      <idea ac="AC5.1">Test 'portfolio' is in CONDITION_TRIGGER_TYPES constant</idea>
      <idea ac="AC5.2">Test valid portfolio expressions: any_holding_change > 5%, total_value >= 100000</idea>
      <idea ac="AC5.2">Test invalid portfolio expressions: unknown_metric > 5%, missing percentage sign</idea>
      <idea ac="AC5.2">Test regex validation for all supported keywords</idea>
      <idea ac="AC5.3">Test default check_interval_minutes=15 for portfolio trigger</idea>
      <idea ac="AC5.3">Test explicit check_interval_minutes override (e.g., 30) works</idea>
      <idea ac="Integration">Full flow: create portfolio intent → verify in list → check pending</idea>
      <idea ac="Integration">Fire portfolio intent with success, verify cooldown/fire_mode applies</idea>
    </ideas>
  </tests>
</story-context>

