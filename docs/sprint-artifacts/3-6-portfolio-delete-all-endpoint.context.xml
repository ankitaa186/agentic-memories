<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>6</storyId>
    <title>Portfolio DELETE All Endpoint (Clear Entire Portfolio)</title>
    <status>ready-for-dev</status>
    <generatedAt>2025-12-14</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-6-portfolio-delete-all-endpoint.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>chatbot (Annie)</asA>
    <iWant>to clear a user's entire portfolio via API</iWant>
    <soThat>users can start fresh or remove all their data</soThat>
    <tasks>
      <task id="1" status="pending">Create Pydantic response model (AC4)
        <subtask>Create PortfolioClearResponse model with fields: deleted (bool), holdings_removed (int)</subtask>
      </task>
      <task id="2" status="pending">Implement confirmation validation (AC2, AC3)
        <subtask>Add confirmation query parameter</subtask>
        <subtask>Validate confirmation equals "DELETE_ALL" (case-sensitive)</subtask>
        <subtask>Return 400 with descriptive error if missing or incorrect</subtask>
      </task>
      <task id="3" status="pending">Implement DELETE all endpoint (AC1, AC4, AC5, AC6)
        <subtask>Add @router.delete("") endpoint (route: /v1/portfolio)</subtask>
        <subtask>Accept user_id and confirmation from query parameters</subtask>
        <subtask>Use DELETE query with rowcount to get deletion count</subtask>
        <subtask>Return confirmation response with holdings_removed count</subtask>
        <subtask>Handle empty portfolio case (0 holdings deleted)</subtask>
      </task>
      <task id="4" status="pending">Write unit tests (AC1, AC2, AC3, AC4, AC5, AC6)
        <subtask>Test DELETE removes all holdings successfully</subtask>
        <subtask>Test confirmation parameter is required (400 if missing)</subtask>
        <subtask>Test invalid confirmation value returns 400</subtask>
        <subtask>Test response includes correct holdings_removed count</subtask>
        <subtask>Test empty portfolio returns 200 with holdings_removed=0</subtask>
        <subtask>Test missing user_id returns 422</subtask>
        <subtask>Test database unavailable returns 500</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1" title="DELETE endpoint clears entire portfolio">
      <given>a user with one or more holdings</given>
      <when>calling DELETE /v1/portfolio?user_id={uuid}&amp;confirmation=DELETE_ALL</when>
      <then>the system deletes ALL holdings for that user and returns confirmation with 200 status</then>
    </criterion>
    <criterion id="AC2" title="Requires confirmation parameter (safety check)">
      <given>a request without confirmation parameter</given>
      <when>calling DELETE /v1/portfolio?user_id={uuid}</when>
      <then>the system returns 400 Bad Request with error message indicating confirmation is required</then>
    </criterion>
    <criterion id="AC3" title="Validates confirmation value">
      <given>a request with incorrect confirmation value</given>
      <when>calling DELETE /v1/portfolio?user_id={uuid}&amp;confirmation=WRONG</when>
      <then>the system returns 400 Bad Request with error message indicating invalid confirmation value</then>
    </criterion>
    <criterion id="AC4" title="Returns deletion count">
      <given>a successful deletion</given>
      <when>the response is returned</when>
      <then>response includes {"deleted": true, "holdings_removed": 5} with count reflecting actual holdings deleted</then>
    </criterion>
    <criterion id="AC5" title="Handles empty portfolio gracefully">
      <given>a user with no holdings</given>
      <when>calling DELETE endpoint with valid confirmation</when>
      <then>the system returns 200 OK with {"deleted": true, "holdings_removed": 0}</then>
    </criterion>
    <criterion id="AC6" title="Request validation for user_id">
      <given>a request with missing user_id parameter</given>
      <when>calling DELETE endpoint</when>
      <then>the system returns 422 Unprocessable Entity with error message indicating missing parameter</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="docs/epic-portfolio-crud-api.md" title="Epic 3: Portfolio Direct CRUD API" section="FR-PC5" snippet="DELETE /v1/portfolio?user_id={uuid}&amp;confirmation=DELETE_ALL clears portfolio. Requires confirmation parameter. Returns count of deleted holdings."/>
      <doc path="docs/sprint-artifacts/3-5-portfolio-delete-single-endpoint.md" title="Story 3.5: DELETE Single Endpoint" section="Dev Agent Record" snippet="DELETE RETURNING pattern, try/except/finally, psycopg3 dict/tuple handling, HoldingDeleteResponse model pattern."/>
    </docs>
    <code>
      <file path="src/routers/portfolio.py" kind="router" symbol="router, HoldingDeleteResponse, delete_holding" lines="81-85, 373-448" reason="Existing DELETE single endpoint pattern to follow; extend with DELETE all endpoint"/>
      <file path="src/dependencies/timescale.py" kind="dependency" symbol="get_timescale_conn, release_timescale_conn" reason="Database connection pattern to follow"/>
      <file path="tests/unit/test_portfolio_api.py" kind="test" symbol="_MockCursor, _MockConnectionWithCommit" lines="12-40, 228-240" reason="Test fixture patterns to reuse for DELETE all tests"/>
    </code>
    <dependencies>
      <python>
        <package name="fastapi" version="0.111.0" usage="APIRouter, Query, HTTPException"/>
        <package name="pydantic" version="2.8.2" usage="BaseModel for PortfolioClearResponse"/>
        <package name="psycopg" version="latest" usage="Database cursor/connection, cursor.rowcount"/>
        <package name="pytest" version="8.3.2" usage="Unit testing"/>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="database">Use simplified schema (Story 3.3): 8 columns only, no intent field</constraint>
    <constraint type="safety">MUST require confirmation=DELETE_ALL parameter (case-sensitive) to prevent accidental mass deletion</constraint>
    <constraint type="pattern">Use cursor.rowcount after DELETE to get count of deleted rows (psycopg pattern)</constraint>
    <constraint type="pattern">Handle both dict and tuple cursor results for psycopg3 compatibility</constraint>
    <constraint type="pattern">Use try/except/finally for connection cleanup with rollback on error</constraint>
    <constraint type="pattern">Use parameterized queries (%s) to prevent SQL injection</constraint>
    <constraint type="api">Return 400 if confirmation parameter missing or incorrect</constraint>
    <constraint type="api">Return 200 on successful delete (even if 0 holdings deleted)</constraint>
    <constraint type="api">Return 422 for missing user_id (FastAPI Query validation)</constraint>
  </constraints>

  <interfaces>
    <interface name="DELETE /v1/portfolio" kind="REST endpoint">
      <signature>DELETE /v1/portfolio?user_id={uuid}&amp;confirmation=DELETE_ALL</signature>
      <request>
        <query-param name="user_id" type="string" required="true" description="User identifier"/>
        <query-param name="confirmation" type="string" required="true" description="Must be 'DELETE_ALL' (case-sensitive)"/>
      </request>
      <response status="200">{"deleted": true, "holdings_removed": 5}</response>
      <response status="400">Confirmation parameter missing or incorrect</response>
      <response status="422">Missing required query parameter (user_id)</response>
      <response status="500">Database error</response>
      <path>src/routers/portfolio.py</path>
    </interface>
    <interface name="get_timescale_conn / release_timescale_conn" kind="function">
      <signature>get_timescale_conn() -> Optional[Connection]; release_timescale_conn(conn: Connection) -> None</signature>
      <description>Database connection pool management</description>
      <path>src/dependencies/timescale.py</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Use pytest with unittest.mock for database mocking. Follow existing test patterns in test_portfolio_api.py.
      Mock _MockCursor, _MockConnectionWithCommit classes.
      Patch src.routers.portfolio.get_timescale_conn and release_timescale_conn.
      Use api_client fixture from conftest.py.
      Test rowcount behavior for DELETE operations.
    </standards>
    <locations>
      <location>tests/unit/test_portfolio_api.py</location>
    </locations>
    <ideas>
      <test ac="AC1" name="test_delete_all_removes_holdings">Test DELETE all removes all holdings successfully, returns 200</test>
      <test ac="AC2" name="test_delete_all_missing_confirmation">Test missing confirmation parameter returns 400</test>
      <test ac="AC3" name="test_delete_all_invalid_confirmation">Test invalid confirmation value returns 400</test>
      <test ac="AC4" name="test_delete_all_returns_count">Test response includes correct holdings_removed count</test>
      <test ac="AC5" name="test_delete_all_empty_portfolio">Test empty portfolio returns 200 with holdings_removed=0</test>
      <test ac="AC6" name="test_delete_all_missing_user_id">Test missing user_id query param returns 422</test>
      <test name="test_delete_all_database_unavailable">Test handling when database connection is unavailable returns 500</test>
      <test name="test_delete_all_confirmation_case_sensitive">Test confirmation must be exactly "DELETE_ALL" (case-sensitive)</test>
    </ideas>
  </tests>
</story-context>
