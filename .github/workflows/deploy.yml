name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: choice
        options:
          - main
          - develop

jobs:
  deploy:
    # NOTE: This workflow requires a self-hosted runner configured for your
    # deployment target. See: https://docs.github.com/en/actions/hosting-your-own-runners
    runs-on: self-hosted
    env:
      DEPLOY_DIR: ${{ vars.DEPLOY_DIR || '/opt/agentic-memories' }}
    steps:
      - name: Deploy to server
        run: |
          cd "$DEPLOY_DIR"

          echo "Fetching latest code for branch: ${{ inputs.branch }}..."
          git fetch --all
          git checkout ${{ inputs.branch }}
          git pull origin ${{ inputs.branch }}

          echo "Starting services..."
          make start

      - name: Healthcheck and Validation
        run: |
          cd "$DEPLOY_DIR"

          echo "Waiting for services to be ready..."
          sleep 10

          # Retry healthcheck up to 30 times (5 min total)
          MAX_RETRIES=30
          RETRY_DELAY=10

          for i in $(seq 1 $MAX_RETRIES); do
            echo "Healthcheck attempt $i/$MAX_RETRIES..."

            if curl -sf http://localhost:8080/health > /dev/null 2>&1; then
              echo "OK: Basic health check passed"
              break
            fi

            if [ $i -eq $MAX_RETRIES ]; then
              echo "FAIL: Health check failed after $MAX_RETRIES attempts"
              docker compose logs --tail=50
              exit 1
            fi

            sleep $RETRY_DELAY
          done

          # Full healthcheck with all components
          echo ""
          echo "Running full healthcheck..."
          FULL_HEALTH=$(curl -sf http://localhost:8080/health/full)
          echo "$FULL_HEALTH" | python3 -m json.tool

          STATUS=$(echo "$FULL_HEALTH" | python3 -c "import sys, json; print(json.load(sys.stdin).get('status', 'unknown'))")
          if [ "$STATUS" != "ok" ]; then
            echo "FAIL: Full healthcheck status is '$STATUS', expected 'ok'"
            docker compose logs --tail=100
            exit 1
          fi
          echo "OK: Full healthcheck passed"

          echo ""
          echo "========================================="
          echo "All healthchecks and validations passed"
          echo "========================================="
